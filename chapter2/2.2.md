### 2.2 CUDA C程序结构

我们现在准备学习如何编写CUDA C程序，以利用数据并行实现更快的执行速度。CUDA C扩展了流行的ANSI C编程语言，添加了最少的新语法和库函数，使程序员能够针对包含CPU核心和大规模并行GPU的异构计算系统。顾名思义，CUDA C建立在NVIDIA的CUDA平台之上。CUDA目前是大规模并行计算最成熟的框架，广泛应用于高性能计算行业，并在大多数常见操作系统上提供了编译器、调试器和性能分析器等基本工具。

CUDA C程序的结构反映了计算机中主机（CPU）和一个或多个设备（GPU）的共存。每个CUDA C源文件可以包含混合的主机代码和设备代码。默认情况下，任何传统的C程序都是仅包含主机代码的CUDA程序。可以将设备代码添加到任何源文件中。设备代码通过特殊的CUDA C关键词明显标记。设备代码包括以数据并行方式执行的函数或内核。

CUDA程序的执行过程如[图2.3](#fig2.3)所示。执行从主机代码（CPU串行代码）开始。当调用一个内核函数时，在设备上启动大量线程来执行内核。由内核调用启动的所有线程统称为一个grid。这些线程是CUDA平台中并行执行的主要载体。[图2.3](fig2.3)展示了两个grid线程的执行。我们很快将讨论这些grid是如何组织的。当一个grid中的所有线程完成执行后，该grid终止，执行继续在主机上，直到启动另一个grid。请注意，[图2.3](#fig2.3)显示了一个简化模型，其中CPU执行和GPU执行不重叠。许多异构计算应用程序管理重叠的CPU和GPU执行，以充分利用CPU和GPU的性能。

<figure>
    <style>
     hr {
         border: none;
         height: 2px;
         background-color: black;
         margin: 5px auto;
     }
	</style>
    <img id="fig2.3" src="..\pic\chapter2\fig2.3.jpeg">
    <figcaption>
        <p class="no-indent" style="font-weight: bold;">
        图2.3
        </p>
       	<hr style="border: none; height: 2px; background-color: black; margin: 5px auto;">
        <p class="no-indent" style="font-family: 'Arial', 'Helvetica', sans-serif;color: #808080">
            CUDA程序的执行过程
        </p>
    </figcaption>
</figure>
启动一个grid通常会生成许多线程以利用数据并行性。在颜色到灰度转换的示例中，每个线程可以用来计算输出数组O的一个像素。在这种情况下，由grid启动生成的线程数应等于图像中的像素数。对于大图像，将生成大量线程。由于有效的硬件支持，CUDA程序员可以假设这些线程生成和调度所需的时钟周期非常少。这一假设与传统的CPU线程形成对比，后者通常需要数千个时钟周期来生成和调度。在下一章中，我们将展示如何实现颜色到灰度转换和图像模糊内核。在本章的其余部分中，我们将使用向量加法作为一个简单的示例。

> #### 线程
>
> 线程是现代计算机中处理器执行顺序程序的简化视图。线程包括程序代码、正在执行的代码位置，以及其变量和数据结构的值。对用户来说，线程的执行是顺序的。可以使用源级调试器通过一次执行一个语句来监控线程的进程，查看将要执行的语句，并在执行过程中检查变量和数据结构的值。
>
> 线程在编程中已经使用了很多年。如果程序员想在应用程序中开始并行执行，他们会使用线程库或特殊语言创建和管理多个线程。在CUDA中，每个线程的执行也是顺序的。CUDA程序通过调用内核函数来启动并行执行，这会使底层运行时机制启动一个线程grid，以并行处理数据的不同部分。

