### 4.3 同步和透明可扩展性

CUDA 允许同一block内的线程使用屏障同步函数 \_\_syncthreads() 来协调它们的活动。注意，“\_\_” 由两个 “_” 字符组成。当一个线程调用 __syncthreads() 时，它将在调用的程序位置处停留，直到同一block中的每个线程都到达该位置。这确保了一个block中的所有线程都已完成其执行的某个阶段，然后才能继续到下一个阶段。

屏障同步是一种简单且流行的协调并行活动的方法。在现实生活中，我们经常使用屏障同步来协调多人的并行活动。例如，假设四个朋友开车去购物中心。他们可以各自去不同的商店购物。这是一种并行活动，比他们作为一个整体依次访问所有感兴趣的商店要高效得多。然而，在离开购物中心之前需要进行屏障同步。他们必须等到四个朋友都回到车里后才能离开。那些比其他人早完成购物的人必须等待那些较晚完成购物的人。如果没有屏障同步，当车离开时，可能会有一个或多个人被留在购物中心，这可能会严重损害他们的友谊！

<figure>
    <style>
     hr {
         border: none;
         height: 2px;
         background-color: black;
         margin: 5px auto;
     }
	</style>
    <img id="fig4.3" src="..\pic\chapter4\fig4.3.jpeg">
    <figcaption>
        <p class="no-indent" style="font-weight: bold;">
        图4.3
        </p>
       	<hr style="border: none; height: 2px; background-color: black; margin: 5px auto;">
        <p class="no-indent" style="font-family: 'Arial', 'Helvetica', sans-serif;color: #808080">
            一个屏障同步执行的例子。箭头表示随时间进行的执行活动。垂直方向的曲线标记了每个线程执行__syncthreads的时间。垂直曲线右侧的空白区域表示每个线程等待所有线程完成的时间。垂直线标记最后一个线程执行 __syncthreads 语句的时间，之后所有线程都可以继续执行 __syncthreads 语句之后的语句。
        </p>
    </figcaption>
</figure>

[图 4.3](#fig4.3) 说明了屏障同步的执行过程。block中有 N 个线程。时间从左到右流逝。一些线程较早到达屏障同步语句，而另一些线程则晚得多。那些较早到达屏障的线程将等待那些较晚到达的线程。当最后一个线程到达屏障时，所有线程才可以继续执行。通过屏障同步，“没有人会被落下。”