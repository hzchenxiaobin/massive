### 4.5 控制分歧

SIMD执行在warp内所有线程遵循相同执行路径（正式称为控制流）时效果良好。例如，对于一个if-else结构，当warp内所有线程都执行if路径或都执行else路径时，执行效果良好。然而，当warp内的线程采取不同的控制流路径时，SIMD硬件将分别对这些路径进行多次遍历，每个路径进行一次遍历。例如，对于一个if-else结构，如果warp中的一些线程遵循if路径，而其他线程遵循else路径，硬件将进行两次遍历。一次遍历执行遵循if路径的线程，另一次遍历执行遵循else路径的线程。在每次遍历中，遵循另一路径的线程将不会生效。

当同一warp中的线程遵循不同的执行路径时，我们称这些线程表现出控制分歧（control divergence），即它们在执行过程中发生了分歧。对分歧warp执行的多次遍历方法扩展了SIMD硬件实现CUDA线程完整语义的能力。虽然硬件为warp中的所有线程执行相同的指令，但它会选择性地在对应于线程所选择路径的遍历中使这些线程生效，从而允许每个线程看起来像是执行了自己的控制流路径。这在保持线程独立性的同时，利用了SIMD硬件的低成本优势。然而，分歧的代价在于硬件需要进行额外的遍历，以允许一个warp中的不同线程做出自己的决定，以及在每次遍历中被非活动线程消耗的执行资源

<figure>
    <style>
     hr {
         border: none;
         height: 2px;
         background-color: black;
         margin: 5px auto;
     }
	</style>
    <img id="fig4.9" src="..\pic\chapter4\fig4.9.jpeg">
    <figcaption>
        <p class="no-indent" style="font-weight: bold;">
        图4.9
        </p>
       	<hr style="border: none; height: 2px; background-color: black; margin: 5px auto;">
        <p class="no-indent" style="font-family: 'Arial', 'Helvetica', sans-serif;color: #808080">
一个warp在if-else语句处分歧的例子
        </p>
    </figcaption>
</figure>

图4.9显示了一个warp如何执行分歧的if-else语句的示例。在这个例子中，当由线程0到31组成的warp到达if-else语句时，线程0到23走then路径，而线程24到31走else路径。在这种情况下，warp将进行一次遍历，线程0到23执行A，而线程24到31不活动。然后，warp将进行另一次遍历，线程24到31执行B，而线程0到23不活动。之后，warp中的线程重新汇合并执行C。在Pascal架构及之前的架构中，这些遍历是顺序执行的，意味着一个遍历完成后再执行另一个遍历。从Volta架构开始，这些遍历可以并行执行，意味着一个遍历的执行可以与另一个遍历的执行交错进行。这个特性被称为独立线程调度。感兴趣的读者可以参考Volta V100架构的白皮书（NVIDIA，2017）了解详细信息。