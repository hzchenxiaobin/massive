### 4.6 Warp调度和延迟容忍

当线程被分配到SM时，通常分配给一个SM的线程数比SM中的核心数要多。也就是说，在任何时候每个SM的执行单元只能执行其分配到的一部分线程。在早期的GPU设计中，每个SM在任意时刻只能为单个warp执行一条指令。在最近的设计中，每个SM可以在任意时刻为少量的warp执行指令。无论哪种情况，硬件都只能为SM中的部分warp执行指令。那么，为什么需要将这么多的warp分配给一个SM，而它在任何时刻只能执行其中的一部分呢？答案是，这是GPU在处理诸如全局内存访问等长延迟操作时的一种容错机制。

当一个warp需要等待先前启动的长延迟操作的结果时，该warp不会被选中执行。相反，将选择另一个不再等待先前指令结果的驻留warp执行。如果有多个warp准备好执行，则使用优先机制选择一个warp执行。这种用其他线程的工作填补一些线程操作延迟时间的机制通常被称为“延迟容忍”或“延迟隐藏”（参见“延迟容忍”边栏）。



> #### 延迟容忍
>
> 延迟容忍在许多日常情境中是必要的。例如，在邮局，每个尝试寄包裹的人理想情况下应该在去服务柜台之前填好所有的表格和标签。然而，正如我们都经历过的，有些人会等到服务柜台后才开始填写表格和标签，并向柜员询问需要填哪种表格以及如何填写。
>
> 当服务柜台前排着长队时，最大化服务人员的工作效率是很重要的。让一个人在柜员面前填写表格，而其他人都在等待，这不是一个好方法。柜员应该在那个人填写表格的同时，帮助排队等待的下一个顾客。这些其他顾客已经“准备好了”，不应该被需要更多时间填写表格的顾客阻碍。
>
> 这就是为什么一个优秀的服务员会礼貌地请第一个顾客稍等到一旁填写表格，同时服务其他顾客。在大多数情况下，第一个顾客不会被要求重新排队，而是在完成表格后，服务员服务完当前顾客后，会尽快为他或她提供服务。
>
> 我们可以将这些邮局顾客视为warp，将服务员视为硬件执行单元。需要填写表格的顾客对应于一个依赖于长延迟操作的warp。

